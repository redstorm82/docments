<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-cn">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>带你入门带你飞Ⅰ 使用Mocha + Chai + Sinon单元测试Node.js - WadeXu - 博客园</title>
<link type="text/css" rel="stylesheet" href="/bundles/blog-common.css?v=VDh8zSH1vx51MDqRT7hK220akQ58FjlaaeGuWBPhfOA1"/>
<link id="MainCss" type="text/css" rel="stylesheet" href="/skins/HabaHaba/bundle-HabaHaba.css?v=Zo8PfphqodA44_wbJuqBW0oJ5ivns_p5H70Wylw_1s01"/>
<link title="RSS" type="application/rss+xml" rel="alternate" href="http://www.cnblogs.com/wade-xu/rss"/>
<link title="RSD" type="application/rsd+xml" rel="EditURI" href="http://www.cnblogs.com/wade-xu/rsd.xml"/>
<link type="application/wlwmanifest+xml" rel="wlwmanifest" href="http://www.cnblogs.com/wade-xu/wlwmanifest.xml"/>
<script src="http://common.cnblogs.com/script/jquery.js" type="text/javascript"></script>  
<script type="text/javascript">var currentBlogApp = 'wade-xu', cb_enable_mathjax=false;</script>
<script src="/bundles/blog-common.js?v=JoVOWMb-iZn6s7f1mHI0Z_8uEB-CbY41K0NgN6_Ttzc1" type="text/javascript"></script>
</head>
<body>
<a name="top"></a>

<table width="100%" class="Framework" cellspacing="0" cellpadding="0">
	<tr>
		<td colspan="2">
			
<div id="top">
<table width="100%" cellpadding="8" cellspacing="0">
	<tr>
		<td nowrap>
			<h1><a id="Header1_HeaderTitle" class="headermaintitle" href="http://www.cnblogs.com/wade-xu/">Wade Xu</a></h1>
			-- 拓展测试的边界
		</td>
	</tr>
</table>
</div>
<div id="sub">
<div class="BlogStats">posts - 15, comments - 47, trackbacks - 0, articles - 0</div></div>


</td>
	</tr>
	<tr>
		<td class="LeftCell">
			<div id="leftmenu">
                
                    
<h3>导航</h3>
<ul>
	<li>
		<a id="MyLinks2_HomeLink" href="http://www.cnblogs.com/">博客园</a>
	<li>
		<a id="MyLinks2_MyHomeLink" href="http://www.cnblogs.com/wade-xu/">首页</a>
	<li>
		<a id="MyLinks2_NewPostLink" rel="nofollow" href="http://i.cnblogs.com/EditPosts.aspx?opt=1">新随笔</a>
	<li>
		<a id="MyLinks2_ContactLink" accesskey="9" rel="nofollow" href="http://msg.cnblogs.com/send/WadeXu">联系</a>
	<li>
		<a id="MyLinks2_XMLLink" href="http://www.cnblogs.com/wade-xu/rss"><img src="http://www.cnblogs.com/images/xml.gif" alt="订阅" /></a><a id="MyLinks2_Syndication" href="http://www.cnblogs.com/wade-xu/rss">订阅</a>
	<li>
		<a id="MyLinks2_Admin" rel="nofollow" href="http://i.cnblogs.com/">管理</a></li>
</ul>

                    
<h3>公告</h3>
<div id="news">
	<div id="blog-news"></div><script type="text/javascript">loadBlogNews();</script>
</div>
                    <div id="blog-calendar" style="display:none"></div><script type="text/javascript">loadBlogDefaultCalendar();</script>
                    <div id="blog-sidecolumn"></div><script type="text/javascript">loadBlogSideColumn();</script>
                	        
			</div>
		</td>
		<td class="MainCell" width="100%">
			<div id="main">
				
<div id="post_detail">
	<div class="post">
		<div class="posthead">
			<h2>
				<a id="cb_post_title_url" class="singleposttitle" href="http://www.cnblogs.com/wade-xu/p/4665250.html">带你入门带你飞Ⅰ 使用Mocha + Chai + Sinon单元测试Node.js</a>
			</h2>
 			Posted on <span id="post-date">2015-07-27 09:41</span> <a href='http://www.cnblogs.com/wade-xu/'>WadeXu</a> 阅读(<span id="post_view_count">...</span>) 评论(<span id="post_comment_count">...</span>)  <a href ="http://i.cnblogs.com/EditPosts.aspx?postid=4665250" rel="nofollow">编辑</a> <a href="#" onclick="AddToWz(4665250);return false;">收藏</a>
			<script type="text/javascript">var allowComments=true,isLogined=false,cb_blogId=211757,cb_entryId=4665250,cb_blogApp=currentBlogApp,cb_blogUserGuid='21bf92c7-2a9a-e411-b908-9dcfd8948a71',cb_entryCreatedDate='2015/7/27 9:41:00';loadViewCount(cb_entryId);</script>
			
		</div>
		<div class="postbody"><div id="cnblogs_post_body"><div class="cnblogs_code">
<pre><span style="font-size: 14px;"><strong>目录</strong></span>
1. 简介
2. 前提条件
3. Mocha入门
4. Mocha实战
     被测代码
  　　Example 1
  　　Example 2
  　　Example 3
5. Troubleshooting
6. 参考文档</pre>
</div>
<p>&nbsp;</p>
<h2>简介</h2>
<p><span style="line-height: 1.5;">Mocha 是具有丰富特性的 JavaScript 测试框架，可以运行在 Node.js 和浏览器中，使得异步测试更简单更有趣。Mocha 可以持续运行测试，支持灵活又准确的报告，当映射到未捕获异常时转到正确的测试示例。</span></p>
<p>Chai&nbsp;是一个针对&nbsp;Node.js&nbsp;和浏览器的行为驱动测试和测试驱动测试的断言库，可与任何 JavaScript&nbsp;测试框架集成。</p>
<p>Sinon 是一个独立的 JavaScript 测试spy, stub, mock库，没有依赖任何单元测试框架工程。</p>
<p>&nbsp;</p>
<h2>前提条件</h2>
<p>我用的node 和 npm 版本如下：</p>
<p>node -v =&nbsp;v0.12.2</p>
<p>npm -v = 2.7.4</p>
<p>当你成功安装nodejs 和 npm 后执行如下命令：</p>
<div class="cnblogs_code">
<pre>npm install -g mocha</pre>
</div>
<div class="cnblogs_code">
<pre>npm install sinon</pre>
</div>
<div class="cnblogs_code">
<pre>npm install chai</pre>
</div>
<p>## mocha global 安装是为了能够在命令行下面使用命令。</p>
<p>&nbsp;</p>
<h2>Mocha入门</h2>
<p>以下为最简单的一个mocha示例：</p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">var</span> assert = require("assert"<span style="color: #000000;">);
describe(</span>'Array', <span style="color: #0000ff;">function</span><span style="color: #000000;">(){
    describe(</span>'#indexOf()', <span style="color: #0000ff;">function</span><span style="color: #000000;">(){
        it(</span>'should return -1 when the value is not present', <span style="color: #0000ff;">function</span><span style="color: #000000;">(){
            assert.equal(</span>-1, [1,2,3].indexOf(5<span style="color: #000000;">));
            assert.equal(</span>-1, [1,2,3].indexOf(0<span style="color: #000000;">));
        })
    })
});</span></pre>
</div>
<ul>
<li>describe (moduleName, testDetails)<br />由上述代码可看出，describe是可以嵌套的，比如上述代码嵌套的两个describe就可以理解成测试人员希望测试Array模块下的#indexOf() 子模块。module_name 是可以随便取的，关键是要让人读明白就好。</li>
<li>it (info, function)<br />具体的测试语句会放在it的回调函数里，一般来说info字符串会写期望的正确输出的简要一句话文字说明。当该it block内的test failed的时候控制台就会把详细信息打印出来。一般是从最外层的describe的module_name开始输出（可以理解成沿着路径或者递归链或者回调链），最后输出info，表示该期望的info内容没有被满足。一个it对应一个实际的test case</li>
<li>assert.equal (exp1, exp2)<br />断言判断exp1结果是否等于exp2, 这里采取的等于判断是== 而并非 === 。即 assert.equal(1, &lsquo;1&rsquo;) 认为是True。这只是nodejs里的assert.js的一种断言形式，下文会提到同样比较常用的chai模块。</li>









</ul>
<p>&nbsp;</p>
<h2>Mocha实战</h2>
<p>项目是基于Express框架的，</p>
<p>项目后台逻辑的层级结构是这样的 Controller -&gt; model -&gt; lib</p>
<p>文件目录结构如下</p>
<div class="cnblogs_code">
<pre>├── config
│   └── config.json
├── controllers
│   └── dashboard
│       └── widgets
│           └── index.js
├── models
│   └── widgets.js
├── lib
│   └── jdbc.js
├── package.json
└── test
    ├── controllers
    │   └── dashboard
    │       └── widgets
    │           └── index_MockTest.js
    ├── models
    │   └── widgetsTest.js
    └── lib
        └── jdbc_mockTest.js</pre>
</div>
<p><span style="line-height: 1.5;">&nbsp;##转载注明出处：<a id="Editor_Edit_hlEntryLink" title="view: 使用Mocha + Chai + Sinon单元测试Node.js" href="http://www.cnblogs.com/wade-xu/p/4665250.html" target="_blank">http://www.cnblogs.com/wade-xu/p/4665250.html</a>&nbsp;</span></p>
<p>&nbsp;</p>
<h3>被测代码</h3>
<p>Controller/dashboard/widgets/index.js</p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">var</span> _widgets = require('../../../models/widgets.js'<span style="color: #000000;">);

module.exports </span>= <span style="color: #0000ff;">function</span><span style="color: #000000;">(router) {

  router.get(</span>'/', <span style="color: #0000ff;">function</span><span style="color: #000000;">(req, res) {
    _widgets.getWidgets(req.user.id)
            .then(</span><span style="color: #0000ff;">function</span><span style="color: #000000;">(widgets){
              </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> res.json(widgets);
            })
            .</span><span style="color: #0000ff;">catch</span>(<span style="color: #0000ff;">function</span><span style="color: #000000;">(err){
              </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> res.json ({
                code: </span>'000-0001'<span style="color: #000000;">,
                message: </span>'failed to get widgets:'+<span style="color: #000000;">err
              });
            });
  });
};</span></pre>
</div>
<p>&nbsp;</p>
<p>models/widgets.js &nbsp; &nbsp;-- functions to get widget of a user from system</p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">var</span> jdbc = require('../lib/jdbc.js'<span style="color: #000000;">);
</span><span style="color: #0000ff;">var</span> Q = require('q'<span style="color: #000000;">);
</span><span style="color: #0000ff;">var</span> Widgets =<span style="color: #000000;"> exports;
<br />
</span><span style="color: #008000;">/*</span><span style="color: #008000;">*
 * Get user widgets
 * @param  {String} userId
 * @return {Promise}
 </span><span style="color: #008000;">*/</span><span style="color: #000000;">
Widgets.getWidgets </span>= <span style="color: #0000ff;">function</span><span style="color: #000000;">(userId) {
    </span><span style="color: #0000ff;">var</span> defer =<span style="color: #000000;"> Q.defer();
    jdbc.query(</span>'select * from t_widget A left join t_widget_config B on A.id = B.widgetId where userId =? order by x,y'<span style="color: #000000;">, [userId])
    .then(</span><span style="color: #0000ff;">function</span><span style="color: #000000;">(rows){
        defer.resolve(convertRows(rows));
    }).</span><span style="color: #0000ff;">catch</span>(<span style="color: #0000ff;">function</span><span style="color: #000000;">(err){
        defer.reject(err);
    });

    </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> defer.promise;
};</span></pre>
</div>
<p>&nbsp;</p>
<p>lib/jdbc.js &nbsp;-- function 连接数据库查询</p>
<div class="cnblogs_code">
<pre><span style="color: #0000ff;">var</span> mysql = require('mysql'<span style="color: #000000;">);
</span><span style="color: #0000ff;">var</span> Promise = require('q'<span style="color: #000000;">);
</span><span style="color: #0000ff;">var</span> databaseConfig = require('../config/config.json'<span style="color: #000000;">).database;

</span><span style="color: #0000ff;">var</span> JDBC_MYSQL =<span style="color: #000000;"> exports;

</span><span style="color: #0000ff;">var</span> pool =<span style="color: #000000;"> mysql.createPool({
    connectionLimit: databaseConfig.connectionLimit,
    host: databaseConfig.host,
    user: databaseConfig.user,
    password: databaseConfig.password,
    port: databaseConfig.port,
    database: databaseConfig.database
});

</span><span style="color: #008000;">/*</span><span style="color: #008000;">*
 * Run database query
 * @param  {String} query
 * @param  {Object} [params]
 * @return {Promise}
 </span><span style="color: #008000;">*/</span><span style="color: #000000;">
JDBC_MYSQL.query </span>= <span style="color: #0000ff;">function</span><span style="color: #000000;">(query, params) {
    </span><span style="color: #0000ff;">var</span> defer =<span style="color: #000000;"> Promise.defer();
    params </span>= params ||<span style="color: #000000;"> {};
    pool.getConnection(</span><span style="color: #0000ff;">function</span><span style="color: #000000;">(err, connection) {
        </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (err) {
            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (connection) {
                connection.release();
            }
            </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> defer.reject(err);
        }
        connection.query(query, params, </span><span style="color: #0000ff;">function</span><span style="color: #000000;">(err, results){
            </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (err) {
                </span><span style="color: #0000ff;">if</span><span style="color: #000000;"> (connection) {
                    connection.release();
                }
                </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> defer.reject(err);
            }
            connection.release();
            defer.resolve(results);
        });
    });
    </span><span style="color: #0000ff;">return</span><span style="color: #000000;"> defer.promise;
};</span></pre>
</div>
<p>&nbsp;</p>
<p>config/config.json &nbsp; --数据库配置</p>
<div class="cnblogs_code">
<pre><span style="color: #000000;">{
    </span>"database"<span style="color: #000000;">: {
        </span>"host" : "10.46.10.007"<span style="color: #000000;">,
        </span>"port" : 3306<span style="color: #000000;">,
        </span>"user" : "wadexu"<span style="color: #000000;">,
        </span>"password" : "wade001"<span style="color: #000000;">,
        </span>"database" : "demo"<span style="color: #000000;">,
        </span>"connectionLimit" : 100<span style="color: #000000;">
    }
}</span></pre>
</div>
<p>&nbsp;##转载注明出处：<a id="Editor_Edit_hlEntryLink" title="view: 使用Mocha + Chai + Sinon单元测试Node.js" href="http://www.cnblogs.com/wade-xu/p/4665250.html" target="_blank">http://www.cnblogs.com/wade-xu/p/4665250.html</a>&nbsp;</p>
<p>&nbsp;</p>
<h3>Example 1</h3>
<p>我们来看如何测试models/widgets.js， 因为是单元测试，所以不应该去连接真正的数据库， 这时候<a href="http://sinonjs.org/" target="_blank">sinon</a>登场了， stub数据库的行为，就是jdbc.js这个依赖。</p>
<p>test/models/widgetsTest.js 如下</p>
<div class="cnblogs_code">
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">var</span> jdbc = require('../../lib/jdbc.js'<span style="color: #000000;">);
</span><span style="color: #008080;"> 2</span> <span style="color: #0000ff;">var</span> widgets = require('../../models/widgets.js'<span style="color: #000000;">);
</span><span style="color: #008080;"> 3</span> 
<span style="color: #008080;"> 4</span> <span style="color: #0000ff;">var</span> chai = require('chai'<span style="color: #000000;">);
</span><span style="color: #008080;"> 5</span> <span style="color: #0000ff;">var</span> should =<span style="color: #000000;"> chai.should();
</span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">var</span> assert =<span style="color: #000000;"> chai.assert;
</span><span style="color: #008080;"> 7</span> 
<span style="color: #008080;"> 8</span> <span style="color: #0000ff;">var</span> chaiAsPromised = require('chai-as-promised'<span style="color: #000000;">);
</span><span style="color: #008080;"> 9</span> <span style="color: #000000;">chai.use(chaiAsPromised);
</span><span style="color: #008080;">10</span> 
<span style="color: #008080;">11</span> <span style="color: #0000ff;">var</span> sinon = require('sinon'<span style="color: #000000;">);
</span><span style="color: #008080;">12</span> <span style="color: #0000ff;">var</span> Q = require('q'<span style="color: #000000;">);
</span><span style="color: #008080;">13</span> 
<span style="color: #008080;">14</span> describe('Widgets', <span style="color: #0000ff;">function</span><span style="color: #000000;">() {
</span><span style="color: #008080;">15</span> 
<span style="color: #008080;">16</span> 
<span style="color: #008080;">17</span>     describe('get widgets', <span style="color: #0000ff;">function</span><span style="color: #000000;">() {
</span><span style="color: #008080;">18</span> 
<span style="color: #008080;">19</span>         <span style="color: #0000ff;">var</span><span style="color: #000000;"> stub;
</span><span style="color: #008080;">20</span> 
<span style="color: #008080;">21</span>         <span style="color: #0000ff;">function</span><span style="color: #000000;"> jdbcPromise() {
</span><span style="color: #008080;">22</span>             <span style="color: #0000ff;">return</span> Q.fcall(<span style="color: #0000ff;">function</span><span style="color: #000000;">() {
</span><span style="color: #008080;">23</span>                 <span style="color: #0000ff;">return</span><span style="color: #000000;"> [{
</span><span style="color: #008080;">24</span>                     widgetId: 10
<span style="color: #008080;">25</span> <span style="color: #000000;">                }];
</span><span style="color: #008080;">26</span> <span style="color: #000000;">            });
</span><span style="color: #008080;">27</span> <span style="color: #000000;">        };
</span><span style="color: #008080;">28</span> 
<span style="color: #008080;">29</span>         beforeEach(<span style="color: #0000ff;">function</span><span style="color: #000000;">() {
</span><span style="color: #008080;">30</span>             stub = sinon.stub(jdbc, "query"<span style="color: #000000;">);
</span><span style="color: #008080;">31</span>             stub.withArgs('select * from t_widget A left join t_widget_config B on A.id = B.widgetId where userId =? order by x,y', [1<span style="color: #000000;">]).returns(jdbcPromise());
</span><span style="color: #008080;">32</span> 
<span style="color: #008080;">33</span> <span style="color: #000000;">        });
</span><span style="color: #008080;">34</span> 
<span style="color: #008080;">35</span>         it('get widgets - 1', <span style="color: #0000ff;">function</span><span style="color: #000000;">() {
</span><span style="color: #008080;">36</span>             <span style="color: #0000ff;">return</span> widgets.getWidgets(1).should.eventually.be.an('array'<span style="color: #000000;">);
</span><span style="color: #008080;">37</span> <span style="color: #000000;">        });
</span><span style="color: #008080;">38</span> 
<span style="color: #008080;">39</span>         afterEach(<span style="color: #0000ff;">function</span><span style="color: #000000;">() {
</span><span style="color: #008080;">40</span> <span style="color: #000000;">            stub.restore();
</span><span style="color: #008080;">41</span> <span style="color: #000000;">        });
</span><span style="color: #008080;">42</span> <span style="color: #000000;">    });
</span><span style="color: #008080;">43</span> });</pre>
</div>
<p>被测代码返回的是promise, 所以我们用到了<a href="http://chaijs.com/plugins/chai-as-promised" target="_blank">Chai as Promised</a>， 它继承了&nbsp;<a href="http://chaijs.com/">Chai</a>,&nbsp; 用一些流利的语言来断言 facts about&nbsp;<a href="http://www.slideshare.net/domenicdenicola/callbacks-promises-and-coroutines-oh-my-the-evolution-of-asynchronicity-in-javascript">promises</a>.</p>
<p>我们stub住 jdbc.query方法 with 什么什么&nbsp;Arguments， 然后返回一个我们自己定义的promise, 这里用到的是<a href="https://www.npmjs.com/package/q" target="_blank">Q</a> promise</p>
<p>断言一定要加 eventually, 表示最终的结果是什么。如果你想断言array里面的具体内容，可以用<a href="http://chaijs.com/plugins/chai-things" target="_blank">chai-things</a>，&nbsp;for assertions on array elements.</p>
<p>&nbsp;</p>
<p>如果要测试catch error那部分代码，则需要模仿error&nbsp;throwing</p>
<div class="cnblogs_code">
<pre><span style="color: #008080;"> 1</span>     describe('get widgets - error', <span style="color: #0000ff;">function</span><span style="color: #000000;">() {
</span><span style="color: #008080;"> 2</span> 
<span style="color: #008080;"> 3</span>         <span style="color: #0000ff;">var</span><span style="color: #000000;"> stub;
</span><span style="color: #008080;"> 4</span> 
<span style="color: #008080;"> 5</span>         <span style="color: #0000ff;">function</span><span style="color: #000000;"> jdbcPromise() {
</span><span style="color: #008080;"> 6</span>             <span style="color: #0000ff;">return</span> Q.fcall(<span style="color: #0000ff;">function</span><span style="color: #000000;">() {
</span><span style="color: #008080;"> 7</span>                 <span style="color: #0000ff;">throw</span> <span style="color: #0000ff;">new</span> Error("widgets error"<span style="color: #000000;">);
</span><span style="color: #008080;"> 8</span> <span style="color: #000000;">            });
</span><span style="color: #008080;"> 9</span> <span style="color: #000000;">        };
</span><span style="color: #008080;">10</span> 
<span style="color: #008080;">11</span>         beforeEach(<span style="color: #0000ff;">function</span><span style="color: #000000;">() {
</span><span style="color: #008080;">12</span>             stub= sinon.stub(jdbc, "query"<span style="color: #000000;">);
</span><span style="color: #008080;">13</span>             stub.withArgs('select * from t_widget A left join t_widget_config B on A.id = B.widgetId where userId =? order by x,y', [1<span style="color: #000000;">]).returns(jdbcPromise());
</span><span style="color: #008080;">14</span> 
<span style="color: #008080;">15</span> <span style="color: #000000;">        });
</span><span style="color: #008080;">16</span> 
<span style="color: #008080;">17</span>         it('get widgets - error', <span style="color: #0000ff;">function</span><span style="color: #000000;">() {
</span><span style="color: #008080;">18</span>             <span style="color: #0000ff;">return</span> widgets.getWidgets(1).should.be.rejectedWith('widgets error'<span style="color: #000000;">);
</span><span style="color: #008080;">19</span> <span style="color: #000000;">        });
</span><span style="color: #008080;">20</span> 
<span style="color: #008080;">21</span>         afterEach(<span style="color: #0000ff;">function</span><span style="color: #000000;">() {
</span><span style="color: #008080;">22</span> <span style="color: #000000;">            stub.restore();
</span><span style="color: #008080;">23</span> <span style="color: #000000;">        });
</span><span style="color: #008080;">24</span>     });</pre>
</div>
<p>&nbsp;</p>
<p>运行测试 结果如下：</p>
<p><img src="http://images0.cnblogs.com/blog2015/713188/201507/221120064901171.jpg" alt="" /></p>
<p>&nbsp;</p>
<h3>Example 2</h3>
<p>接下来我想测试controller层， 那stub的对象就变成了widgets这个依赖了，</p>
<p>在这里我们用到了<a href="https://www.npmjs.com/package/supertest" target="_blank">supertest</a>来模拟发送http request, 类似功能的模块还有<a href="http://chaijs.com/plugins/chai-http" target="_blank">chai-http</a></p>
<p>如果我们不去stub,mock 的话也可以，这样利用supertest 来发送http request 测试controller-&gt;model-&gt;lib, 每层都测到了， 这就是Integration&nbsp;testing了。</p>
<div class="cnblogs_code">
<pre><span style="color: #008080;"> 1</span> <span style="color: #0000ff;">var</span> kraken = require('kraken-js'<span style="color: #000000;">);
</span><span style="color: #008080;"> 2</span> <span style="color: #0000ff;">var</span> express = require('express'<span style="color: #000000;">);
</span><span style="color: #008080;"> 3</span> <span style="color: #0000ff;">var</span> request = require('supertest'<span style="color: #000000;">);
</span><span style="color: #008080;"> 4</span> 
<span style="color: #008080;"> 5</span> <span style="color: #0000ff;">var</span> chai = require('chai'<span style="color: #000000;">);
</span><span style="color: #008080;"> 6</span> <span style="color: #0000ff;">var</span> assert =<span style="color: #000000;"> chai.assert;
</span><span style="color: #008080;"> 7</span> <span style="color: #0000ff;">var</span> sinon = require('sinon'<span style="color: #000000;">);
</span><span style="color: #008080;"> 8</span> <span style="color: #0000ff;">var</span> Q = require('q'<span style="color: #000000;">);
</span><span style="color: #008080;"> 9</span> 
<span style="color: #008080;">10</span> <span style="color: #0000ff;">var</span> widgets = require('../../../../models/widgets.js'<span style="color: #000000;">);
</span><span style="color: #008080;">11</span> 
<span style="color: #008080;">12</span> describe('/dashboard/widgets', <span style="color: #0000ff;">function</span><span style="color: #000000;">() {
</span><span style="color: #008080;">13</span> 
<span style="color: #008080;">14</span>   <span style="color: #0000ff;">var</span><span style="color: #000000;"> app, mock;
</span><span style="color: #008080;">15</span> 
<span style="color: #008080;">16</span>   before(<span style="color: #0000ff;">function</span><span style="color: #000000;">(done) {
</span><span style="color: #008080;">17</span>     app =<span style="color: #000000;"> express();
</span><span style="color: #008080;">18</span>     app.on('start'<span style="color: #000000;">, done);
</span><span style="color: #008080;">19</span> 
<span style="color: #008080;">20</span> <span style="color: #000000;">    app.use(kraken({
</span><span style="color: #008080;">21</span> <span style="color: #000000;">      basedir: process.cwd(),
</span><span style="color: #008080;">22</span>       onconfig: <span style="color: #0000ff;">function</span><span style="color: #000000;">(config, next) {
</span><span style="color: #008080;">23</span>         <span style="color: #008000;">//</span><span style="color: #008000;">some config info, such as login user info in req</span>
<span style="color: #008080;">24</span> <span style="color: #000000;">    } }));
</span><span style="color: #008080;">25</span> 
<span style="color: #008080;">26</span>     mock = app.listen(1337<span style="color: #000000;">);
</span><span style="color: #008080;">27</span> 
<span style="color: #008080;">28</span> <span style="color: #000000;">  });
</span><span style="color: #008080;">29</span> 
<span style="color: #008080;">30</span>   after(<span style="color: #0000ff;">function</span><span style="color: #000000;">(done) {
</span><span style="color: #008080;">31</span> <span style="color: #000000;">    mock.close(done);
</span><span style="color: #008080;">32</span> <span style="color: #000000;">  });
</span><span style="color: #008080;">33</span> 
<span style="color: #008080;">34</span>   describe('get widgets', <span style="color: #0000ff;">function</span><span style="color: #000000;">() {
</span><span style="color: #008080;">35</span> 
<span style="color: #008080;">36</span>     <span style="color: #0000ff;">var</span><span style="color: #000000;"> stub;
</span><span style="color: #008080;">37</span> 
<span style="color: #008080;">38</span>     <span style="color: #0000ff;">function</span><span style="color: #000000;"> jdbcPromise() {
</span><span style="color: #008080;">39</span>       <span style="color: #0000ff;">return</span> Q.fcall(<span style="color: #0000ff;">function</span><span style="color: #000000;">() {
</span><span style="color: #008080;">40</span>         <span style="color: #0000ff;">return</span><span style="color: #000000;"> {
</span><span style="color: #008080;">41</span>           widgetId: 10
<span style="color: #008080;">42</span> <span style="color: #000000;">        };
</span><span style="color: #008080;">43</span> <span style="color: #000000;">      });
</span><span style="color: #008080;">44</span> <span style="color: #000000;">    };
</span><span style="color: #008080;">45</span> 
<span style="color: #008080;">46</span>     beforeEach(<span style="color: #0000ff;">function</span><span style="color: #000000;">() {
</span><span style="color: #008080;">47</span>       stub = sinon.stub(widgets, "getWidgets"<span style="color: #000000;">);
</span><span style="color: #008080;">48</span>       stub.withArgs('wade-xu'<span style="color: #000000;">).returns(jdbcPromise());
</span><span style="color: #008080;">49</span> 
<span style="color: #008080;">50</span> <span style="color: #000000;">    });
</span><span style="color: #008080;">51</span> 
<span style="color: #008080;">52</span>     it('get widgets', <span style="color: #0000ff;">function</span><span style="color: #000000;">(done) {
</span><span style="color: #008080;">53</span> <span style="color: #000000;">      request(mock)
</span><span style="color: #008080;">54</span>         .get('/dashboard/widgets/'<span style="color: #000000;">)
</span><span style="color: #008080;">55</span>         .expect(200<span style="color: #000000;">)
</span><span style="color: #008080;">56</span>         .expect('Content-Type', /json/<span style="color: #000000;">)
</span><span style="color: #008080;">57</span>         .end(<span style="color: #0000ff;">function</span><span style="color: #000000;">(err, res) {
</span><span style="color: #008080;">58</span>           <span style="color: #0000ff;">if</span> (err) <span style="color: #0000ff;">return</span><span style="color: #000000;"> done(err);
</span><span style="color: #008080;">59</span>           assert.equal(res.body.widgetId, '10'<span style="color: #000000;">);
</span><span style="color: #008080;">60</span> <span style="color: #000000;">          done();
</span><span style="color: #008080;">61</span> <span style="color: #000000;">        });
</span><span style="color: #008080;">62</span> <span style="color: #000000;">    });
</span><span style="color: #008080;">63</span> 
<span style="color: #008080;">64</span>     afterEach(<span style="color: #0000ff;">function</span><span style="color: #000000;">() {
</span><span style="color: #008080;">65</span> <span style="color: #000000;">      stub.restore();
</span><span style="color: #008080;">66</span> <span style="color: #000000;">    });
</span><span style="color: #008080;">67</span> <span style="color: #000000;">  });
</span><span style="color: #008080;">68</span> });</pre>
</div>
<p>注意，it里面用了Mocha提供的done()函数来测试异步代码，在最深处的回调函数中加done()表示结束测试, 否则测试会报错，因为测试不等异步函数执行完毕就结束了。</p>
<p>在Example1里面我们没有用done() 回调函数, 那是因为我们用了Chai as Promised&nbsp;来代替。</p>
<p>&nbsp;</p>
<p>运行测试 结果如下：</p>
<p><img src="http://images0.cnblogs.com/blog2015/713188/201507/221152268651342.jpg" alt="" /></p>
<p>&nbsp;##转载注明出处：<a id="Editor_Edit_hlEntryLink" title="view: 使用Mocha + Chai + Sinon单元测试Node.js" href="http://www.cnblogs.com/wade-xu/p/4665250.html" target="_blank">http://www.cnblogs.com/wade-xu/p/4665250.html</a>&nbsp;</p>
<p>&nbsp;</p>
<h3>Example 3</h3>
<p>测试jdbc.js 同理，需要stub mysql 这个module的行为， 代码如下：</p>
<div class="cnblogs_code">
<pre><span style="color: #008080;">  1</span> <span style="color: #0000ff;">var</span> mysql = require('mysql'<span style="color: #000000;">);
</span><span style="color: #008080;">  2</span> 
<span style="color: #008080;">  3</span> <span style="color: #0000ff;">var</span> databaseConfig = require('../../config/config.json'<span style="color: #000000;">).database;
</span><span style="color: #008080;">  4</span> 
<span style="color: #008080;">  5</span> <span style="color: #0000ff;">var</span> chai = require('chai'<span style="color: #000000;">);
</span><span style="color: #008080;">  6</span> <span style="color: #0000ff;">var</span> assert =<span style="color: #000000;"> chai.assert;
</span><span style="color: #008080;">  7</span> <span style="color: #0000ff;">var</span> expect =<span style="color: #000000;"> chai.expect;
</span><span style="color: #008080;">  8</span> <span style="color: #0000ff;">var</span> should =<span style="color: #000000;"> chai.should();
</span><span style="color: #008080;">  9</span> <span style="color: #0000ff;">var</span> sinon = require('sinon'<span style="color: #000000;">);
</span><span style="color: #008080;"> 10</span> <span style="color: #0000ff;">var</span> Q = require('q'<span style="color: #000000;">);
</span><span style="color: #008080;"> 11</span> <span style="color: #0000ff;">var</span> chaiAsPromised = require('chai-as-promised'<span style="color: #000000;">);
</span><span style="color: #008080;"> 12</span> 
<span style="color: #008080;"> 13</span> <span style="color: #000000;">chai.use(chaiAsPromised);
</span><span style="color: #008080;"> 14</span> 
<span style="color: #008080;"> 15</span> <span style="color: #0000ff;">var</span> config =<span style="color: #000000;"> {
</span><span style="color: #008080;"> 16</span> <span style="color: #000000;">  connectionLimit: databaseConfig.connectionLimit,
</span><span style="color: #008080;"> 17</span> <span style="color: #000000;">  host: databaseConfig.host,
</span><span style="color: #008080;"> 18</span> <span style="color: #000000;">  user: databaseConfig.user,
</span><span style="color: #008080;"> 19</span> <span style="color: #000000;">  password: databaseConfig.password,
</span><span style="color: #008080;"> 20</span> <span style="color: #000000;">  port: databaseConfig.port,
</span><span style="color: #008080;"> 21</span> <span style="color: #000000;">  database: databaseConfig.database
</span><span style="color: #008080;"> 22</span> <span style="color: #000000;">};
</span><span style="color: #008080;"> 23</span> 
<span style="color: #008080;"> 24</span> describe('jdbc', <span style="color: #0000ff;">function</span><span style="color: #000000;">() {
</span><span style="color: #008080;"> 25</span> 
<span style="color: #008080;"> 26</span>   describe('mock query', <span style="color: #0000ff;">function</span><span style="color: #000000;">() {
</span><span style="color: #008080;"> 27</span> 
<span style="color: #008080;"> 28</span>     <span style="color: #0000ff;">var</span><span style="color: #000000;"> stub;
</span><span style="color: #008080;"> 29</span>     <span style="color: #0000ff;">var</span><span style="color: #000000;"> spy;
</span><span style="color: #008080;"> 30</span>     <span style="color: #0000ff;">var</span> myPool =<span style="color: #000000;"> {
</span><span style="color: #008080;"> 31</span>       getConnection: <span style="color: #0000ff;">function</span><span style="color: #000000;">(cb) {
</span><span style="color: #008080;"> 32</span>         <span style="color: #0000ff;">var</span> connection =<span style="color: #000000;"> {
</span><span style="color: #008080;"> 33</span>           release: <span style="color: #0000ff;">function</span><span style="color: #000000;">() {},
</span><span style="color: #008080;"> 34</span>           query: <span style="color: #0000ff;">function</span><span style="color: #000000;">(query, params, qcb) {
</span><span style="color: #008080;"> 35</span>             <span style="color: #0000ff;">var</span> mockQueries =<span style="color: #000000;"> {
</span><span style="color: #008080;"> 36</span>               q1: 'select * from t_widget where userId =?'
<span style="color: #008080;"> 37</span> <span style="color: #000000;">            }
</span><span style="color: #008080;"> 38</span> 
<span style="color: #008080;"> 39</span>             <span style="color: #0000ff;">if</span> (query === mockQueries.q1 &amp;&amp; params === '81EFF5C2'<span style="color: #000000;">) {
</span><span style="color: #008080;"> 40</span>               <span style="color: #0000ff;">return</span> qcb(<span style="color: #0000ff;">null</span>, 'success query'<span style="color: #000000;">);
</span><span style="color: #008080;"> 41</span>             } <span style="color: #0000ff;">else</span><span style="color: #000000;"> {
</span><span style="color: #008080;"> 42</span>               <span style="color: #0000ff;">return</span> qcb(<span style="color: #0000ff;">new</span> Error('fail to query'<span style="color: #000000;">));
</span><span style="color: #008080;"> 43</span> <span style="color: #000000;">            }
</span><span style="color: #008080;"> 44</span> <span style="color: #000000;">          }
</span><span style="color: #008080;"> 45</span> <span style="color: #000000;">        };
</span><span style="color: #008080;"> 46</span>         spy = sinon.spy(connection, "release"<span style="color: #000000;">);
</span><span style="color: #008080;"> 47</span>         cb(<span style="color: #0000ff;">null</span><span style="color: #000000;">, connection);
</span><span style="color: #008080;"> 48</span> <span style="color: #000000;">      }
</span><span style="color: #008080;"> 49</span> <span style="color: #000000;">    };
</span><span style="color: #008080;"> 50</span> 
<span style="color: #008080;"> 51</span> 
<span style="color: #008080;"> 52</span>     beforeEach(<span style="color: #0000ff;">function</span><span style="color: #000000;">() {
</span><span style="color: #008080;"> 53</span>       stub = sinon.stub(mysql, "createPool"<span style="color: #000000;">);
</span><span style="color: #008080;"> 54</span> <span style="color: #000000;">      stub.withArgs(config).returns(myPool);
</span><span style="color: #008080;"> 55</span> 
<span style="color: #008080;"> 56</span> <span style="color: #000000;">    });
</span><span style="color: #008080;"> 57</span> 
<span style="color: #008080;"> 58</span>     it('query success', <span style="color: #0000ff;">function</span><span style="color: #000000;">() {
</span><span style="color: #008080;"> 59</span>       <span style="color: #0000ff;">delete</span> require.cache[require.resolve('../../lib/jdbc.js'<span style="color: #000000;">)];
</span><span style="color: #008080;"> 60</span>       <span style="color: #0000ff;">var</span> jdbc = require('../../lib/jdbc.js'<span style="color: #000000;">);
</span><span style="color: #008080;"> 61</span>       jdbc.query('select * from t_widget where userId =?', '81EFF5C2').should.eventually.deep.equal('success query'<span style="color: #000000;">);
</span><span style="color: #008080;"> 62</span> <span style="color: #000000;">      assert(spy.calledOnce);
</span><span style="color: #008080;"> 63</span> <span style="color: #000000;">    });
</span><span style="color: #008080;"> 64</span> 
<span style="color: #008080;"> 65</span>     it('query error', <span style="color: #0000ff;">function</span><span style="color: #000000;">() {
</span><span style="color: #008080;"> 66</span>       <span style="color: #0000ff;">delete</span> require.cache[require.resolve('../../lib/jdbc.js'<span style="color: #000000;">)];
</span><span style="color: #008080;"> 67</span>       <span style="color: #0000ff;">var</span> jdbc = require('../../lib/jdbc.js'<span style="color: #000000;">);
</span><span style="color: #008080;"> 68</span>       jdbc.query('select * from t_widget where userId =?', 'WrongID').should.be.rejectedWith('fail to query'<span style="color: #000000;">);
</span><span style="color: #008080;"> 69</span> <span style="color: #000000;">      assert(spy.calledOnce);
</span><span style="color: #008080;"> 70</span> <span style="color: #000000;">    });
</span><span style="color: #008080;"> 71</span> 
<span style="color: #008080;"> 72</span>     afterEach(<span style="color: #0000ff;">function</span><span style="color: #000000;">() {
</span><span style="color: #008080;"> 73</span> <span style="color: #000000;">      stub.restore();
</span><span style="color: #008080;"> 74</span> <span style="color: #000000;">      spy.restore();
</span><span style="color: #008080;"> 75</span> <span style="color: #000000;">    });
</span><span style="color: #008080;"> 76</span> 
<span style="color: #008080;"> 77</span> <span style="color: #000000;">  });
</span><span style="color: #008080;"> 78</span> 
<span style="color: #008080;"> 79</span>   describe('mock query error ', <span style="color: #0000ff;">function</span><span style="color: #000000;">() {
</span><span style="color: #008080;"> 80</span> 
<span style="color: #008080;"> 81</span>     <span style="color: #0000ff;">var</span><span style="color: #000000;"> stub;
</span><span style="color: #008080;"> 82</span>     <span style="color: #0000ff;">var</span><span style="color: #000000;"> spy;
</span><span style="color: #008080;"> 83</span> 
<span style="color: #008080;"> 84</span>     <span style="color: #0000ff;">var</span> myPool =<span style="color: #000000;"> {
</span><span style="color: #008080;"> 85</span>       getConnection: <span style="color: #0000ff;">function</span><span style="color: #000000;">(cb) {
</span><span style="color: #008080;"> 86</span>         <span style="color: #0000ff;">var</span> connection =<span style="color: #000000;"> {
</span><span style="color: #008080;"> 87</span>           release: <span style="color: #0000ff;">function</span><span style="color: #000000;">() {},
</span><span style="color: #008080;"> 88</span> <span style="color: #000000;">        };
</span><span style="color: #008080;"> 89</span>         spy = sinon.spy(connection, "release"<span style="color: #000000;">);
</span><span style="color: #008080;"> 90</span>         cb(<span style="color: #0000ff;">new</span> Error('Pool get connection error'<span style="color: #000000;">));
</span><span style="color: #008080;"> 91</span> <span style="color: #000000;">      }
</span><span style="color: #008080;"> 92</span> <span style="color: #000000;">    };
</span><span style="color: #008080;"> 93</span> 
<span style="color: #008080;"> 94</span>     beforeEach(<span style="color: #0000ff;">function</span><span style="color: #000000;">() {
</span><span style="color: #008080;"> 95</span>       stub = sinon.stub(mysql, "createPool"<span style="color: #000000;">);
</span><span style="color: #008080;"> 96</span> <span style="color: #000000;">      stub.withArgs(config).returns(myPool);
</span><span style="color: #008080;"> 97</span> <span style="color: #000000;">    });
</span><span style="color: #008080;"> 98</span> 
<span style="color: #008080;"> 99</span>     it('query error without connection', <span style="color: #0000ff;">function</span><span style="color: #000000;">() {
</span><span style="color: #008080;">100</span>       <span style="color: #0000ff;">delete</span> require.cache[require.resolve('../../lib/jdbc.js'<span style="color: #000000;">)];
</span><span style="color: #008080;">101</span>       <span style="color: #0000ff;">var</span> jdbc = require('../../lib/jdbc.js'<span style="color: #000000;">);
</span><span style="color: #008080;">102</span>       jdbc.query('select * from t_widget where userId =?', '81EFF5C2').should.be.rejectedWith('Pool get connection error'<span style="color: #000000;">);
</span><span style="color: #008080;">103</span> 
<span style="color: #008080;">104</span> <span style="color: #000000;">      assert.isFalse(spy.called);
</span><span style="color: #008080;">105</span> <span style="color: #000000;">    });
</span><span style="color: #008080;">106</span> 
<span style="color: #008080;">107</span>     afterEach(<span style="color: #0000ff;">function</span><span style="color: #000000;">() {
</span><span style="color: #008080;">108</span> <span style="color: #000000;">      stub.restore();
</span><span style="color: #008080;">109</span> <span style="color: #000000;">      spy.restore();
</span><span style="color: #008080;">110</span> <span style="color: #000000;">    });
</span><span style="color: #008080;">111</span> 
<span style="color: #008080;">112</span> <span style="color: #000000;">  });
</span><span style="color: #008080;">113</span> 
<span style="color: #008080;">114</span> });</pre>
</div>
<p>这里要注意的是我每个case里面都是 delete cache 不然只有第一个case会pass, 后面的都会报错, 后面的case返回的myPool都是第一个case的,&nbsp;因为第一次create Pool之后返回的 myPool被存入cache里了。</p>
<p>&nbsp;</p>
<p>测试运行结果如下</p>
<p><img src="http://images0.cnblogs.com/blog2015/713188/201507/221349440066723.jpg" alt="" /></p>
<p>&nbsp;##转载注明出处：<a id="Editor_Edit_hlEntryLink" title="view: 使用Mocha + Chai + Sinon单元测试Node.js" href="http://www.cnblogs.com/wade-xu/p/4665250.html" target="_blank">http://www.cnblogs.com/wade-xu/p/4665250.html</a>&nbsp;</p>
<p>&nbsp;</p>
<h2>Troubleshooting</h2>
<p>1. stub.withArgs(XXX).returns(XXX) 这里的参数要和stub的那个方法里面的参数保持一致。</p>
<p>2. stub某个对象的方法 还有onFirstCall(), onSecondCall() 做不同的事情。</p>
<p>3. 文中提到过如何&nbsp;remove module after &ldquo;require&rdquo; in node.js 不然创建的数据库连接池pool一直在cache里， 后面的case无法更改它.</p>
<p>&nbsp; &nbsp;delete require.cache[require.resolve('../../lib/jdbc.js')];</p>
<p>4. 如何引入chai-as-promised</p>
<p>var chaiAsPromised = require('chai-as-promised');<br /><span style="line-height: 1.5;">chai.use(chaiAsPromised);</span></p>
<p>5. mocha无法命令行运行，设置好你的环境变量PATH路径&nbsp;</p>
<p>&nbsp;</p>
<h2>参考文档</h2>
<p>Mocha:&nbsp;<a href="http://mochajs.org/" target="_blank">http://mochajs.org/</a></p>
<p>Chai:&nbsp;<a href="http://chaijs.com/" target="_blank">http://chaijs.com/</a></p>
<p>Sinon:&nbsp;<a href="http://sinonjs.org/" target="_blank">http://sinonjs.org/</a></p>
<p>&nbsp;</p>
<p><strong>感谢阅读，如果您觉得本文的内容对您的学习有所帮助，您可以点击右下方的推荐按钮，您的鼓励是我创作的动力。</strong></p>
<p>##转载注明出处：<a id="Editor_Edit_hlEntryLink" title="view: 使用Mocha + Chai + Sinon单元测试Node.js" href="http://www.cnblogs.com/wade-xu/p/4665250.html" target="_blank">http://www.cnblogs.com/wade-xu/p/4665250.html</a>&nbsp;</p>
<p>&nbsp;</p></div><div id="MySignature"></div>
<div class="clear"></div>
<div id="blog_post_info_block">
<div id="BlogPostCategory"></div>
<div id="EntryTag"></div>
<div id="blog_post_info">
</div>
<div class="clear"></div>
<div id="post_next_prev"></div>
</div>

</div>
	</div></div><a name="!comments"></a><div id="blog-comments-placeholder"></div><script type="text/javascript">var commentManager = new blogCommentManager();commentManager.renderComments(0);</script>
<div id="comment_form" class="commentform">
<a name="commentform"></a>
<div id="divCommentShow"></div>
<div id="comment_nav"><span id="span_refresh_tips"></span><a href="javascript:void(0);" id="lnk_RefreshComments" onclick="return RefreshCommentList();">刷新评论</a><a href="#" onclick="return RefreshPage();">刷新页面</a><a href="#top">返回顶部</a></div>
<div id="comment_form_container"></div>
<div class="ad_text_commentbox" id="ad_text_under_commentbox"></div>
<div id="site_nav_under"><a href="http://www.cnblogs.com/" target="_blank" title="开发者的网上家园">博客园首页</a><a href="http://q.cnblogs.com/" target="_blank" title="程序员问答社区">博问</a><a href="http://news.cnblogs.com/" target="_blank" title="IT新闻">新闻</a><a href="http://home.cnblogs.com/ing/" target="_blank">闪存</a><a href="http://job.cnblogs.com/" target="_blank">程序员招聘</a><a href="http://kb.cnblogs.com/" target="_blank">知识库</a></div>
<div id="opt_under_post"></div>
<script type="text/javascript">
    var enableGoogleAd = canShowAdsense(); 
    fixPostBodyFormat();
</script>
<script type='text/javascript'>
  var googletag = googletag || {};
  googletag.cmd = googletag.cmd || [];
    (function () {
        if (enableGoogleAd) {
            var gads = document.createElement('script');
            gads.async = true;
            gads.type = 'text/javascript';
            var useSSL = 'https:' == document.location.protocol;
            gads.src = (useSSL ? 'https:' : 'http:') +
              '//www.googletagservices.com/tag/js/gpt.js';
            var node = document.getElementsByTagName('script')[0];
            node.parentNode.insertBefore(gads, node);
        }
  })();
</script>
<script type='text/javascript'>
    try {
        if (enableGoogleAd) {
            googletag.cmd.push(function() {
            googletag.defineSlot('/1090369/cnblogs_blogpost_C2', [468, 60], 'div-gpt-ad-1433581717989-0').addService(googletag.pubads());
            googletag.defineSlot('/1090369/cnblogs_blogpost_C1_sitehome', [300, 250], 'div-gpt-ad-1433581717989-1').addService(googletag.pubads());
            googletag.pubads().enableSingleRequest();
            googletag.pubads().collapseEmptyDivs();
            googletag.enableServices();
            });
        };
    } catch (e) { }
</script>
<div id="google_ad_c1" class="c_ad_block">
    <div id='div-gpt-ad-1433581717989-1' style='height:250px; width:300px;'>
    <script type='text/javascript'>
        try {
            if (enableGoogleAd) {
                googletag.cmd.push(function () { googletag.display('div-gpt-ad-1433581717989-1'); });
            } else {
                $('#div-gpt-ad-1433581717989-1').hide();
            }
    } catch (e) { }
    </script>
    </div>
</div>
<div id="under_post_news"></div>
<div id="google_ad_c2" class="c_ad_block">
<div id='div-gpt-ad-1433581717989-0' style='height:60px; width:468px;'>
<script type='text/javascript'>
try {
    if (enableGoogleAd) {
        googletag.cmd.push(function () { googletag.display('div-gpt-ad-1433581717989-0'); });
    } else {
        $('#div-gpt-ad-1433581717989-0').hide();
    }
} catch (e) { }
</script>
</div>
</div>
<div id="under_post_kb"></div>
<div id="HistoryToday" class="c_ad_block"></div>
<script type="text/javascript">
$(function () {
    loadNewsAndKb();
    loadBlogSignature();
    LoadPostInfoBlock(cb_blogId, cb_entryId, cb_blogApp, cb_blogUserGuid);
    GetPrevNextPost(cb_entryId, cb_blogId, cb_entryCreatedDate);
    loadOptUnderPost();
    GetHistoryToday(cb_blogId, cb_blogApp, cb_entryCreatedDate);
    setTimeout(function () { incrementViewCount(cb_entryId); }, 200);
});
</script>
</div>

			</div>
		</td>
	</tr>
	<tr>
		<td colspan="2" class="FooterCell">
			
<p id="footer">
	Powered by: 
	<br />
	
	<a id="Footer1_Hyperlink3" NAME="Hyperlink1" href="http://www.cnblogs.com/" style="font-family:Verdana;font-size:12px;">博客园</a>
	<br />
	Copyright &copy; WadeXu
</p>
		</td>
	</tr>
</table>


</body>
</html>
